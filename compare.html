<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VWX5EMQSLM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-VWX5EMQSLM');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Compare ship energy efficiency with peer vessels of the same type. See how ships rank against similar vessels in CO2 efficiency.">
    <meta name="robots" content="index, follow">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:site_name" content="Dirtiest Ships">
    <meta property="og:title" content="Ship Efficiency Comparison - Dirtiest Ships">
    <meta property="og:description" content="Compare ship energy efficiency with peer vessels of the same type.">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9641573711172527"
     crossorigin="anonymous"></script>
    <title>Peer Comparison - Dirtiest Ships</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <img src="images/ship-smoke-left.jpg" alt="" class="header-img header-img-left">
            <img src="images/ship-smoke-right.jpg" alt="" class="header-img header-img-right">
            <h1>Dirtiest Ships <span style="font-size: 0.5em; font-weight: normal;">(in Europe)</span></h1>
            <p class="subtitle">Peer Efficiency Comparison</p>
            <nav>
                <a href="index.html">Ship Rankings</a>
                <a href="chart.html">By Ship Type</a>
                <a href="companies.html">By Company</a>
                <a href="countries.html">By Country</a>
                <a href="compare.html" class="active">Peer Compare</a>
                <a href="rules.html">Regulations</a>
                <a href="FAQ.html">Why?</a>
            </nav>
        </header>

        <div class="search-section">
            <h2>Select a Ship to Compare</h2>
            <div class="search-container">
                <input type="text" class="search-input" id="shipSearch" placeholder="Search by ship name or IMO number...">
                <div class="search-results" id="searchResults"></div>
            </div>
        </div>

        <div class="comparison-section" id="comparisonSection">
            <div class="selected-ship" id="selectedShipInfo">
                <!-- Selected ship info populated by JS -->
            </div>

            <div class="extremes-section" id="extremesSection">
                <!-- Best and worst performers populated by JS -->
            </div>

            <div class="chart-container">
                <h3>Theoretical Efficiency Comparison Chart</h3>
                <div class="filter-controls" style="margin-bottom: 15px;">
                    <label class="checkbox-label" style="display: inline-flex; align-items: center; cursor: pointer; color: #ccc;">
                        <input type="checkbox" id="deadweightFilter" style="margin-right: 8px; cursor: pointer;">
                        <span>Deadweight filter</span>
                        <span id="dwtFilterInfo" style="margin-left: 8px; font-size: 0.85em; color: #888;"></span>
                    </label>
                </div>
                <div class="chart-wrapper">
                    <canvas id="comparisonChart"></canvas>
                </div>
                <p style="font-size: 0.85em; color: #888; margin-top: 10px;">Based on design efficiency indicator (EEDI/EEXI/EIV)</p>
            </div>

            <div class="chart-container">
                <h3>Actual Efficiency Comparison Chart</h3>
                <div class="chart-wrapper">
                    <canvas id="transportWorkChart"></canvas>
                </div>
                <p id="transportWorkNote" style="font-size: 0.85em; color: #888; margin-top: 10px;"></p>
            </div>

            <div class="ranking-section">
                <h3 id="rankingTitle">Peer Ranking by Energy Efficiency</h3>
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>Type Rank</th>
                            <th>Ship Name</th>
                            <th>Registry</th>
                            <th style="text-align: right;">Efficiency (gCO2/t-nm)</th>
                        </tr>
                    </thead>
                    <tbody id="rankingTableBody">
                        <!-- Rankings populated by JS -->
                    </tbody>
                </table>
            </div>

            <div class="methodology-note">
                <strong>Note:</strong> Ships are ranked by their energy efficiency rating (gCO2/t-nm) - lower values indicate better fuel efficiency.
                Only ships with reported efficiency ratings are included in this comparison. The efficiency metric shown is the ship's
                design efficiency indicator (EEDI, EEXI, or EIV) as reported in EU MRV data.
            </div>
        </div>

        <div class="no-data-message" id="noDataMessage" style="display: none;">
            <h3>No Efficiency Data Available</h3>
            <p>This ship does not have efficiency rating data, or there are not enough peers of the same type with efficiency data for comparison.</p>
            <p style="margin-top: 15px;"><a href="index.html" style="color: #4ecdc4;">Back to Ship Rankings</a></p>
        </div>

        <footer>
            <div class="footer-links">
                <a href="FAQ.html">FAQ</a>
                <a href="disclaimer.html">Disclaimer</a>
                <a href="mailto:hello@dirtiestships.com">hello@dirtiestships.com</a>
            </div>
            <p>Data source: <a href="https://mrv.emsa.europa.eu/" target="_blank">EU MRV Regulation</a> (2024)</p>
            <p>This data shows energy efficiency ratings for ships calling at EU/EEA ports.</p>
        </footer>
    </div>

    <script>
        let allShips = [];
        let selectedShip = null;
        let comparisonChart = null;
        let transportWorkChart = null;
        let meohVessels = new Set();
        let shipSpecs = {};  // Cache for ship specifications
        let currentSameTypeShips = [];  // Store for re-filtering
        let selectedShipDwt = null;

        // Get appropriate transport metric based on ship type
        function getTransportMetric(shipType) {
            const type = (shipType || '').toLowerCase();
            if (type.includes('passenger') || type.includes('cruise') || type.includes('ro-pax')) {
                return { key: 'pax', label: 'g CO₂ / passenger · n mile', desc: 'Per Passenger' };
            } else if (type.includes('container') || type.includes('cargo') || type.includes('bulk')) {
                return { key: 'freight', label: 'g CO₂ / m tonnes · n mile', desc: 'Per Freight Tonne', fallback: 'mass' };
            } else if (type.includes('tanker') || type.includes('lng') || type.includes('lpg')) {
                return { key: 'volume', label: 'g CO₂ / m³ · n mile', desc: 'Per Volume', fallback: 'mass' };
            } else {
                return { key: 'mass', label: 'g CO₂ / m tonnes · n mile', desc: 'Per Mass', fallback: 'dwt' };
            }
        }

        // Get transport work value for a ship
        function getTransportWork(ship, metric) {
            if (!ship.fuel_per_transport) return null;
            let value = ship.fuel_per_transport[metric.key];
            if (value == null && metric.fallback) {
                value = ship.fuel_per_transport[metric.fallback];
            }
            return value != null ? parseFloat(value) : null;
        }

        // Load ship specs from JSON
        async function loadShipSpecs(imo) {
            if (shipSpecs[imo]) return shipSpecs[imo];
            try {
                const encoded = encodeId(imo);
                const response = await fetch(`json/ship/${encoded}.json`);
                if (response.ok) {
                    const data = await response.json();
                    shipSpecs[imo] = data;
                    return data;
                }
            } catch (e) {}
            return null;
        }

        // Load MeOH-capable vessels list
        fetch('json/meoh_vessels.json')
            .then(response => response.json())
            .then(data => {
                meohVessels = new Set(data.vessels.map(v => v.imo));
            })
            .catch(() => {});

        // Unpadded Base64 encoding (removes trailing =)
        function encodeId(imo) {
            return btoa(imo).replace(/=+$/, '');
        }

        // Decode unpadded Base64
        function decodeId(encoded) {
            // Add padding back if needed
            const padded = encoded + '==='.slice(0, (4 - encoded.length % 4) % 4);
            try {
                return atob(padded);
            } catch (e) {
                return null;
            }
        }

        // Parse efficiency value from string like "EEDI (5.41 gCO₂/t·nm)"
        function parseEfficiency(efficiencyStr) {
            if (!efficiencyStr) return null;
            const match = efficiencyStr.match(/\((\d+\.?\d*)\s*gCO/);
            if (match) {
                return parseFloat(match[1]);
            }
            return null;
        }

        // Load ship data
        function loadData() {
            fetch('json/2024_ships_data.json')
                .then(response => response.json())
                .then(data => {
                    allShips = data.ships;
                    checkURLForShip();
                })
                .catch(error => {
                    console.error('Error loading data:', error);
                });
        }

        // Check if IMO is in URL
        function checkURLForShip() {
            const params = new URLSearchParams(window.location.search);
            const encoded = params.get('id');
            const imo = encoded ? decodeId(encoded) : null;
            if (imo) {
                const ship = allShips.find(s => s.imo === imo);
                if (ship) {
                    selectShip(ship);
                }
            }
        }

        // Search functionality
        const searchInput = document.getElementById('shipSearch');
        const searchResults = document.getElementById('searchResults');

        searchInput.addEventListener('input', function() {
            const query = this.value.toLowerCase().trim();

            if (query.length < 2) {
                searchResults.classList.remove('active');
                return;
            }

            const matches = allShips.filter(ship =>
                ship.name.toLowerCase().includes(query) ||
                ship.imo.includes(query)
            ).slice(0, 10);

            if (matches.length === 0) {
                searchResults.innerHTML = '<div class="search-result-item"><span class="search-result-name">No ships found</span></div>';
            } else {
                searchResults.innerHTML = matches.map(ship => `
                    <div class="search-result-item" data-imo="${ship.imo}">
                        <div class="search-result-name">${escapeHtml(ship.name)}</div>
                        <div class="search-result-meta">IMO: ${ship.imo} | ${escapeHtml(ship.type)} | ${ship.efficiency || 'No efficiency data'}</div>
                    </div>
                `).join('');
            }

            searchResults.classList.add('active');
        });

        searchResults.addEventListener('click', function(e) {
            const item = e.target.closest('.search-result-item');
            if (item && item.dataset.imo) {
                const ship = allShips.find(s => s.imo === item.dataset.imo);
                if (ship) {
                    selectShip(ship);
                    searchInput.value = '';
                    searchResults.classList.remove('active');
                    // Update URL
                    history.pushState(null, '', `?id=${encodeId(ship.imo)}`);
                }
            }
        });

        // Close search results when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.search-container')) {
                searchResults.classList.remove('active');
            }
        });

        // Select a ship and show comparison
        async function selectShip(ship) {
            selectedShip = ship;
            const efficiency = parseEfficiency(ship.efficiency);

            if (!efficiency) {
                document.getElementById('comparisonSection').classList.remove('active');
                document.getElementById('noDataMessage').style.display = 'block';
                return;
            }

            // Get all ships of the same type with efficiency data
            const sameTypeShips = allShips
                .filter(s => s.type === ship.type && parseEfficiency(s.efficiency) !== null)
                .map(s => ({
                    ...s,
                    efficiencyValue: parseEfficiency(s.efficiency)
                }))
                .sort((a, b) => a.efficiencyValue - b.efficiencyValue); // Lower is better

            if (sameTypeShips.length < 3) {
                document.getElementById('comparisonSection').classList.remove('active');
                document.getElementById('noDataMessage').style.display = 'block';
                return;
            }

            // Find selected ship's position
            const selectedIndex = sameTypeShips.findIndex(s => s.imo === ship.imo);

            // Add type rank to all ships
            sameTypeShips.forEach((s, idx) => {
                s.typeRank = idx + 1;
            });

            const totalInType = sameTypeShips.length;
            const selectedShipData = sameTypeShips[selectedIndex];

            // Store for re-filtering
            currentSameTypeShips = sameTypeShips;

            // Load specs for selected ship to get deadweight
            const selectedSpecs = await loadShipSpecs(ship.imo);
            selectedShipDwt = selectedSpecs?.deadweight ? parseFloat(selectedSpecs.deadweight) : null;

            // Update filter info and reset checkbox
            const dwtFilterInfo = document.getElementById('dwtFilterInfo');
            const dwtCheckbox = document.getElementById('deadweightFilter');
            dwtCheckbox.checked = false;  // Reset on new ship selection
            if (selectedShipDwt) {
                const range = selectedShipDwt >= 50000 ? '±20%' : '±50%';
                dwtFilterInfo.textContent = `(${Math.round(selectedShipDwt).toLocaleString()} DWT, ${range} range)`;
                dwtCheckbox.disabled = false;
            } else {
                dwtFilterInfo.textContent = '(no DWT data)';
                dwtCheckbox.disabled = true;
                dwtCheckbox.checked = false;
            }

            // Load specs for all same-type ships in background
            Promise.all(sameTypeShips.map(s => loadShipSpecs(s.imo))).then(() => {
                // Re-apply filter if checkbox is checked
                if (dwtCheckbox.checked) {
                    applyDeadweightFilter();
                }
            });

            // Show comparison section
            document.getElementById('noDataMessage').style.display = 'none';
            document.getElementById('comparisonSection').classList.add('active');

            // Update selected ship info
            const selectedMeohTag = meohVessels.has(ship.imo) ? ' <span class="meoh-tag">&lt;MeOH&gt;</span>' : '';
            document.getElementById('selectedShipInfo').innerHTML = `
                <h2>${escapeHtml(ship.name)}${selectedMeohTag}</h2>
                <div class="selected-ship-meta">IMO: ${ship.imo} | ${escapeHtml(ship.type)} | Registry: ${escapeHtml(ship.registry)}</div>
                <div class="selected-ship-efficiency">
                    <div class="efficiency-box">
                        <div class="efficiency-label">Energy Efficiency</div>
                        <div class="efficiency-value">${efficiency.toFixed(2)} gCO2/t-nm</div>
                    </div>
                    <div class="efficiency-box">
                        <div class="efficiency-label">Rank in ${escapeHtml(ship.type)}</div>
                        <div class="efficiency-value">#${selectedShipData.typeRank} of ${totalInType}</div>
                    </div>
                    <div class="efficiency-box">
                        <div class="efficiency-label">Percentile</div>
                        <div class="efficiency-value">${((selectedShipData.typeRank / totalInType) * 100).toFixed(1)}%</div>
                    </div>
                </div>
            `;

            // Best and worst performers
            const bestShip = sameTypeShips[0];
            const worstShip = sameTypeShips[sameTypeShips.length - 1];

            document.getElementById('extremesSection').innerHTML = `
                <div class="extreme-box best">
                    <div class="extreme-title">Most Efficient ${escapeHtml(ship.type)}</div>
                    <div class="extreme-ship-name"><a href="ship.html?id=${encodeId(bestShip.imo)}">${escapeHtml(bestShip.name)}</a></div>
                    <div class="extreme-value">${bestShip.efficiencyValue.toFixed(2)} gCO2/t-nm</div>
                </div>
                <div class="extreme-box worst">
                    <div class="extreme-title">Least Efficient ${escapeHtml(ship.type)}</div>
                    <div class="extreme-ship-name"><a href="ship.html?id=${encodeId(worstShip.imo)}">${escapeHtml(worstShip.name)}</a></div>
                    <div class="extreme-value">${worstShip.efficiencyValue.toFixed(2)} gCO2/t-nm</div>
                </div>
            `;

            // Initial render (uses applyDeadweightFilter with checkbox unchecked)
            applyDeadweightFilter();
        }

        function renderComparisonChart(ships, selectedImo) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');

            if (comparisonChart) {
                comparisonChart.destroy();
            }

            const labels = ships.map(s => s.name.length > 20 ? s.name.substring(0, 20) + '...' : s.name);
            const data = ships.map(s => s.efficiencyValue);
            const colors = ships.map(s => s.imo === selectedImo ? '#4ecdc4' : 'rgba(255, 107, 107, 0.7)');
            const borderColors = ships.map(s => s.imo === selectedImo ? '#4ecdc4' : '#ff6b6b');

            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Efficiency (gCO2/t-nm)',
                        data: data,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const ship = ships[context.dataIndex];
                                    return `${ship.efficiencyValue.toFixed(2)} gCO2/t-nm (Rank #${ship.typeRank})`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            title: {
                                display: true,
                                text: 'Energy Efficiency (gCO2/t-nm) - Lower is Better',
                                color: '#888'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#888',
                                font: { size: 11 }
                            },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        }

        function renderTransportWorkChart(ships, selectedImo, shipType) {
            const ctx = document.getElementById('transportWorkChart').getContext('2d');
            const metric = getTransportMetric(shipType);

            if (transportWorkChart) {
                transportWorkChart.destroy();
            }

            // Filter ships that have transport work data
            const shipsWithData = ships.filter(s => getTransportWork(s, metric) !== null);

            if (shipsWithData.length < 2) {
                document.getElementById('transportWorkNote').textContent = 'Insufficient transport work data available for comparison.';
                ctx.canvas.parentElement.style.display = 'none';
                return;
            }

            ctx.canvas.parentElement.style.display = 'block';
            document.getElementById('transportWorkNote').textContent = `Based on actual CO₂ emissions per transport work (${metric.desc.toLowerCase()}) - Lower is better`;

            const labels = shipsWithData.map(s => s.name.length > 20 ? s.name.substring(0, 20) + '...' : s.name);
            const data = shipsWithData.map(s => getTransportWork(s, metric));
            const colors = shipsWithData.map(s => s.imo === selectedImo ? '#4ecdc4' : 'rgba(255, 107, 107, 0.7)');
            const borderColors = shipsWithData.map(s => s.imo === selectedImo ? '#4ecdc4' : '#ff6b6b');

            transportWorkChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: metric.label,
                        data: data,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const ship = shipsWithData[context.dataIndex];
                                    return `${context.raw.toFixed(2)} ${metric.label}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            title: {
                                display: true,
                                text: metric.label + ' - Lower is Better',
                                color: '#888'
                            }
                        },
                        y: {
                            ticks: {
                                color: '#888',
                                font: { size: 11 }
                            },
                            grid: { color: 'rgba(255,255,255,0.05)' }
                        }
                    }
                }
            });
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Apply deadweight filter and re-render
        function applyDeadweightFilter() {
            if (!selectedShip || !currentSameTypeShips.length) return;

            const dwtCheckbox = document.getElementById('deadweightFilter');
            const efficiency = parseEfficiency(selectedShip.efficiency);
            let filteredShips = [...currentSameTypeShips];

            if (dwtCheckbox.checked && selectedShipDwt) {
                // Determine range: ±50% for <50k DWT, ±20% for >=50k DWT
                const rangePct = selectedShipDwt >= 50000 ? 0.20 : 0.50;
                const minDwt = selectedShipDwt * (1 - rangePct);
                const maxDwt = selectedShipDwt * (1 + rangePct);

                filteredShips = currentSameTypeShips.filter(s => {
                    const specs = shipSpecs[s.imo];
                    if (!specs?.deadweight) return false;
                    const dwt = parseFloat(specs.deadweight);
                    return dwt >= minDwt && dwt <= maxDwt;
                });

                // Ensure selected ship is included
                if (!filteredShips.find(s => s.imo === selectedShip.imo)) {
                    const selectedShipData = currentSameTypeShips.find(s => s.imo === selectedShip.imo);
                    if (selectedShipData) filteredShips.push(selectedShipData);
                    filteredShips.sort((a, b) => a.efficiencyValue - b.efficiencyValue);
                }
            }

            // Re-assign type ranks within filtered set
            filteredShips.forEach((s, idx) => {
                s.filteredRank = idx + 1;
            });

            const selectedIndex = filteredShips.findIndex(s => s.imo === selectedShip.imo);

            // Build peer list: 7 above, selected, 7 below
            let peerShips = [];
            const startIdx = Math.max(0, selectedIndex - 7);
            const endIdx = Math.min(filteredShips.length, selectedIndex + 8);

            for (let i = startIdx; i < endIdx; i++) {
                peerShips.push(filteredShips[i]);
            }

            // Ensure we have up to 15 ships if possible
            if (peerShips.length < 15) {
                if (startIdx === 0 && endIdx < filteredShips.length) {
                    const need = Math.min(15 - peerShips.length, filteredShips.length - endIdx);
                    for (let i = 0; i < need; i++) {
                        peerShips.push(filteredShips[endIdx + i]);
                    }
                } else if (endIdx === filteredShips.length && startIdx > 0) {
                    const need = Math.min(15 - peerShips.length, startIdx);
                    for (let i = need; i > 0; i--) {
                        peerShips.unshift(filteredShips[startIdx - i]);
                    }
                }
            }

            // Update ranking title
            const filterLabel = dwtCheckbox.checked ? ' - DWT filtered' : '';
            document.getElementById('rankingTitle').textContent =
                `Peer Ranking - ${escapeHtml(selectedShip.type)} (${filteredShips.length} ships${filterLabel})`;

            // Render ranking table
            const tableBody = document.getElementById('rankingTableBody');
            const displayRank = dwtCheckbox.checked ? 'filteredRank' : 'typeRank';
            tableBody.innerHTML = peerShips.map(s => {
                const isSelected = s.imo === selectedShip.imo;
                const isBetter = s.efficiencyValue < efficiency;
                const rowClass = isSelected ? 'selected-row' : (isBetter ? 'better' : 'worse');
                const meohTag = meohVessels.has(s.imo) ? ' <span class="meoh-tag">&lt;MeOH&gt;</span>' : '';

                return `
                    <tr class="${rowClass}">
                        <td class="rank-cell">#${s[displayRank]}</td>
                        <td class="ship-name-cell"><a href="ship.html?id=${encodeId(s.imo)}">${escapeHtml(s.name)}</a>${meohTag}</td>
                        <td>${escapeHtml(s.registry)}</td>
                        <td class="efficiency-cell">${s.efficiencyValue.toFixed(2)}</td>
                    </tr>
                `;
            }).join('');

            // Render charts
            renderComparisonChart(peerShips, selectedShip.imo);
            renderTransportWorkChart(peerShips, selectedShip.imo, selectedShip.type);
        }

        // Checkbox event listener
        document.getElementById('deadweightFilter').addEventListener('change', applyDeadweightFilter);

        // Initialize
        loadData();
    </script>
</body>
</html>
