<!DOCTYPE html>
<html lang="en">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VWX5EMQSLM"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-VWX5EMQSLM');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Independent ranking of the highest CO₂-emitting ships operating in Europe, based on verified emissions data. Sort by vessel, operator, or ship type.">
    <meta name="keywords" content="ship emissions, CO2 emissions, maritime pollution, EU MRV, shipping emissions, dirtiest ships, ship CO2 ranking, maritime CO2, vessel emissions, shipping pollution">
    <meta name="author" content="Dirtiest Ships">
    <meta name="robots" content="index, follow">
    <link rel="canonical" href="https://dirtiestships.com/">

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://dirtiestships.com/">
    <meta property="og:title" content="Dirtiest Ships in Europe – CO₂ Emissions Ranking">
    <meta property="og:description" content="Independent ranking of the highest CO₂-emitting ships operating in Europe, based on verified emissions data.">
    <meta property="og:site_name" content="Dirtiest Ships">

    <!-- Twitter -->
    <meta name="twitter:card" content="summary_large_image">
    <meta name="twitter:url" content="https://dirtiestships.com/">
    <meta name="twitter:title" content="Dirtiest Ships in Europe – CO₂ Emissions Ranking">
    <meta name="twitter:description" content="Independent ranking of the highest CO₂-emitting ships operating in Europe, based on verified emissions data.">

    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-9641573711172527"
     crossorigin="anonymous"></script>
    <title>Dirtiest Ships in Europe – CO₂ Emissions Ranking | DirtiestShips.com</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <header>
            <img src="images/ship-smoke-left.jpg" alt="" class="header-img header-img-left">
            <img src="images/ship-smoke-right.jpg" alt="" class="header-img header-img-right">
            <h1>Dirtiest Ships <span style="font-size: 0.5em; font-weight: normal;">(in Europe)</span></h1>
            <p class="subtitle" id="subtitle">EU MRV Annual CO2 Emissions Ranking 2024</p>
            <nav>
                <div class="year-selector">
                    <select id="year-select">
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                    </select>
                </div>
                <a href="index.html" class="active">Rankings</a>
                <a href="charts.html">Charts</a>
                <a href="compare.html">Compare</a>
                <a href="cii.html">CII Ratings</a>
                <a href="news.html">News</a>
                <a href="FAQ.html">Why?</a>
            </nav>
            <div class="stats">
                <div class="stat-box">
                    <div class="stat-value" id="total-ships">-</div>
                    <div class="stat-label">Ships Tracked</div>
                </div>
                <div class="stat-box stat-box-link" id="co2-stat-box" title="View emissions trend">
                    <div class="stat-value" id="total-co2">-</div>
                    <div class="stat-label" id="co2-label">Total CO2 (million tonnes)</div>
                </div>
                <div class="stat-box">
                    <div class="stat-value" id="total-ets">-</div>
                    <div class="stat-label">EU ETS 2024 (€ bn)</div>
                </div>
                <a href="https://tradingeconomics.com/commodity/carbon" target="_blank" class="stat-box stat-box-link" title="View historic EUA prices">
                    <div class="stat-value" id="eua-price">-</div>
                    <div class="stat-label">EUA Price Today</div>
                </a>
                <div class="stat-box">
                    <div class="stat-value" id="ets-projected">-</div>
                    <div class="stat-label">EU ETS 2026 (€ bn)</div>
                </div>
            </div>
        </header>

        <div class="controls">
            <div class="search-box autocomplete-container">
                <input type="text" id="search" placeholder="Search by ship name or IMO number..." autocomplete="off">
                <div class="autocomplete-dropdown" id="autocomplete-dropdown"></div>
            </div>
            <div class="filter-box">
                <select id="ship-type-filter">
                    <option value="">All Ship Types</option>
                </select>
            </div>
        </div>

        <div class="table-container">
            <table>
                <thead>
                    <tr>
                        <th data-sort="rank" class="sorted-asc">Rank</th>
                        <th data-sort="name">Ship Name</th>
                        <th data-sort="type">Type</th>
                        <th data-sort="registry">Registry</th>
                        <th data-sort="co2" id="co2-header">CO2 (m tonnes)</th>
                    </tr>
                </thead>
                <tbody id="ships-table">
                    <!-- Loading skeletons -->
                    <tr class="skeleton-row-tr"><td colspan="5"><div class="skeleton-row"><div class="skeleton-cell rank"></div><div class="skeleton-cell name"></div><div class="skeleton-cell type"></div><div class="skeleton-cell registry"></div><div class="skeleton-cell co2"></div></div></td></tr>
                    <tr class="skeleton-row-tr"><td colspan="5"><div class="skeleton-row"><div class="skeleton-cell rank"></div><div class="skeleton-cell name"></div><div class="skeleton-cell type"></div><div class="skeleton-cell registry"></div><div class="skeleton-cell co2"></div></div></td></tr>
                    <tr class="skeleton-row-tr"><td colspan="5"><div class="skeleton-row"><div class="skeleton-cell rank"></div><div class="skeleton-cell name"></div><div class="skeleton-cell type"></div><div class="skeleton-cell registry"></div><div class="skeleton-cell co2"></div></div></td></tr>
                    <tr class="skeleton-row-tr"><td colspan="5"><div class="skeleton-row"><div class="skeleton-cell rank"></div><div class="skeleton-cell name"></div><div class="skeleton-cell type"></div><div class="skeleton-cell registry"></div><div class="skeleton-cell co2"></div></div></td></tr>
                    <tr class="skeleton-row-tr"><td colspan="5"><div class="skeleton-row"><div class="skeleton-cell rank"></div><div class="skeleton-cell name"></div><div class="skeleton-cell type"></div><div class="skeleton-cell registry"></div><div class="skeleton-cell co2"></div></div></td></tr>
                    <tr class="skeleton-row-tr"><td colspan="5"><div class="skeleton-row"><div class="skeleton-cell rank"></div><div class="skeleton-cell name"></div><div class="skeleton-cell type"></div><div class="skeleton-cell registry"></div><div class="skeleton-cell co2"></div></div></td></tr>
                    <tr class="skeleton-row-tr"><td colspan="5"><div class="skeleton-row"><div class="skeleton-cell rank"></div><div class="skeleton-cell name"></div><div class="skeleton-cell type"></div><div class="skeleton-cell registry"></div><div class="skeleton-cell co2"></div></div></td></tr>
                    <tr class="skeleton-row-tr"><td colspan="5"><div class="skeleton-row"><div class="skeleton-cell rank"></div><div class="skeleton-cell name"></div><div class="skeleton-cell type"></div><div class="skeleton-cell registry"></div><div class="skeleton-cell co2"></div></div></td></tr>
                </tbody>
            </table>
        </div>

        <div class="pagination">
            <button id="prev-btn">Previous</button>
            <span class="page-info" id="page-info">Page 1 of 1</span>
            <button id="next-btn">Next</button>
        </div>

        <footer>
            <div class="footer-links">
                <a href="FAQ.html">FAQ</a>
                <a href="rules.html">Regulations</a>
                <a href="disclaimer.html">Disclaimer</a>
                <a href="mailto:hello@dirtiestships.com">hello@dirtiestships.com</a>
            </div>
            <p>Data source: <a href="https://mrv.emsa.europa.eu/" target="_blank">EU MRV Regulation</a></p>
            <p>This data shows annual CO2 emissions from ships calling at EU/EEA ports.</p>
        </footer>
    </div>

    <div class="trend-overlay" id="trend-overlay">
        <div class="trend-popup">
            <button class="trend-close" id="trend-close">&times;</button>
            <h3 class="trend-title">Total Emissions Trend (2020-2024)</h3>
            <div class="trend-chart-wrapper">
                <canvas id="trendChart"></canvas>
            </div>
            <p class="trend-note">Note: 2024 uses CO2-eq (includes methane etc.), 2020-2023 use CO2 only.</p>
        </div>
    </div>

    <script>
        let allShips = [];
        let filteredShips = [];
        let currentPage = 1;
        const perPage = 50;
        let sortColumn = 'rank';
        let sortDirection = 'asc';
        let currentYear = '2024';
        let meohVessels = new Set();
        let euaPrice = 65; // Default fallback price

        // Unpadded Base64 encoding (removes trailing =)
        function encodeId(imo) {
            return btoa(imo).replace(/=+$/, '');
        }

        // Load EUA price
        fetch('json/eua_price.json')
            .then(response => response.json())
            .then(data => {
                euaPrice = data.price;
                document.getElementById('eua-price').textContent = '€' + euaPrice.toFixed(0);
                // Recalculate projected ETS if data already loaded
                if (allShips.length > 0 && currentYear === '2024') {
                    updateProjectedEts();
                }
            })
            .catch(() => {
                document.getElementById('eua-price').textContent = '€' + euaPrice.toFixed(0);
            });

        function updateProjectedEts() {
            // 2026 projected: 100% scope * current EUA price (assuming same emissions as 2024)
            const totalEmissions = allShips.reduce((sum, ship) => sum + (ship.co2eq || 0), 0);
            const etsProjected = 1.0 * totalEmissions * euaPrice;
            document.getElementById('ets-projected').textContent = (etsProjected / 1000000000).toFixed(1);
        }

        // Load MeOH-capable vessels list
        fetch('json/meoh_vessels.json')
            .then(response => response.json())
            .then(data => {
                meohVessels = new Set(data.vessels.map(v => v.imo));
            })
            .catch(() => {});

        function loadData(year) {
            currentYear = year;
            const isNew = year === '2024';
            const co2Field = isNew ? 'co2eq' : 'co2';
            const co2Label = isNew ? 'CO2-eq' : 'CO2';

            // Update UI labels
            document.getElementById('subtitle').textContent = `EU MRV Annual ${co2Label} Emissions Ranking ${year}`;
            document.getElementById('co2-label').textContent = `Total ${co2Label} (million tonnes)`;
            document.getElementById('co2-header').textContent = `${co2Label} (m tonnes)`;
            document.getElementById('co2-header').dataset.sort = co2Field;

            // Reset
            document.getElementById('ships-table').innerHTML = '<tr><td colspan="5" class="loading">Loading data...</td></tr>';
            document.getElementById('search').value = '';
            document.getElementById('ship-type-filter').innerHTML = '<option value="">All Ship Types</option>';

            fetch(`json/${year}_ships_data.json`)
                .then(response => response.json())
                .then(data => {
                    allShips = data.ships;
                    filteredShips = [...allShips];

                    // Update stats
                    document.getElementById('total-ships').textContent = data.total_ships.toLocaleString();
                    const totalEmissions = isNew ? data.total_co2eq : data.total_co2;
                    document.getElementById('total-co2').textContent = (totalEmissions / 1000000).toFixed(2);

                    // Calculate EU ETS 2024: 40% scope * €65/tonne (historical)
                    if (year === '2024') {
                        const euEts2024 = 0.4 * totalEmissions * 65;
                        document.getElementById('total-ets').textContent = (euEts2024 / 1000000000).toFixed(1);
                        // Calculate 2026 projected: 100% scope * current EUA price
                        updateProjectedEts();
                    } else {
                        document.getElementById('total-ets').textContent = 'N/A';
                        document.getElementById('ets-projected').textContent = 'N/A';
                    }

                    // Populate ship type filter
                    const types = [...new Set(allShips.map(s => s.type))].filter(t => t).sort();
                    const typeFilter = document.getElementById('ship-type-filter');
                    types.forEach(type => {
                        const option = document.createElement('option');
                        option.value = type;
                        option.textContent = type;
                        typeFilter.appendChild(option);
                    });

                    currentPage = 1;
                    sortColumn = 'rank';
                    sortDirection = 'asc';
                    renderTable();
                })
                .catch(error => {
                    document.getElementById('ships-table').innerHTML =
                        '<tr><td colspan="5" class="loading">Error loading data.</td></tr>';
                });
        }

        function renderTable() {
            const tbody = document.getElementById('ships-table');
            const start = (currentPage - 1) * perPage;
            const end = start + perPage;
            const pageShips = filteredShips.slice(start, end);
            const isNew = currentYear === '2024';
            const co2Field = isNew ? 'co2eq' : 'co2';

            if (pageShips.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="loading">No ships found matching your criteria.</td></tr>';
            } else {
                tbody.innerHTML = pageShips.map((ship, index) => {
                    const meohTag = meohVessels.has(ship.imo) ? ' <span class="meoh-tag">&lt;MeOH&gt;</span>' : '';
                    const animDelay = `style="animation-delay: ${index * 0.02}s"`;
                    return `
                    <tr ${animDelay}>
                        <td class="rank ${ship.rank <= 3 ? 'rank-' + ship.rank : ''}">#${ship.rank}</td>
                        <td class="ship-name"><a href="ship.html?id=${encodeId(ship.imo)}" class="ship-link">${escapeHtml(ship.name)}</a>${meohTag}</td>
                        <td class="ship-type">${escapeHtml(ship.type)}</td>
                        <td>${escapeHtml(ship.registry)}</td>
                        <td class="co2-value">${ship[co2Field].toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>
                    </tr>
                `}).join('');
            }

            const totalPages = Math.ceil(filteredShips.length / perPage);
            document.getElementById('page-info').textContent = `Page ${currentPage} of ${totalPages} (${filteredShips.length.toLocaleString()} ships)`;
            document.getElementById('prev-btn').disabled = currentPage === 1;
            document.getElementById('next-btn').disabled = currentPage >= totalPages;
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function applyFilters() {
            const searchTerm = document.getElementById('search').value.toLowerCase();
            const typeFilter = document.getElementById('ship-type-filter').value;

            filteredShips = allShips.filter(ship => {
                const matchesSearch = !searchTerm ||
                    ship.name.toLowerCase().includes(searchTerm) ||
                    ship.imo.includes(searchTerm);
                const matchesType = !typeFilter || ship.type === typeFilter;
                return matchesSearch && matchesType;
            });

            sortShips();
            currentPage = 1;
            renderTable();
        }

        function sortShips() {
            const isNew = currentYear === '2024';
            const co2Field = isNew ? 'co2eq' : 'co2';

            filteredShips.sort((a, b) => {
                let aVal = sortColumn === 'co2' ? a[co2Field] : a[sortColumn];
                let bVal = sortColumn === 'co2' ? b[co2Field] : b[sortColumn];

                if (typeof aVal === 'string') {
                    aVal = aVal.toLowerCase();
                    bVal = bVal.toLowerCase();
                }

                if (aVal < bVal) return sortDirection === 'asc' ? -1 : 1;
                if (aVal > bVal) return sortDirection === 'asc' ? 1 : -1;
                return 0;
            });
        }

        // ============================================
        // AUTOCOMPLETE FUNCTIONALITY
        // ============================================
        const RECENT_SEARCHES_KEY = 'dirtiestships_recent_searches';
        const MAX_RECENT_SEARCHES = 5;
        const MAX_SUGGESTIONS = 8;
        let selectedAutocompleteIndex = -1;

        function getRecentSearches() {
            try {
                return JSON.parse(localStorage.getItem(RECENT_SEARCHES_KEY)) || [];
            } catch {
                return [];
            }
        }

        function saveRecentSearch(ship) {
            const recent = getRecentSearches().filter(s => s.imo !== ship.imo);
            recent.unshift({ imo: ship.imo, name: ship.name, type: ship.type, rank: ship.rank });
            localStorage.setItem(RECENT_SEARCHES_KEY, JSON.stringify(recent.slice(0, MAX_RECENT_SEARCHES)));
        }

        function clearRecentSearches() {
            localStorage.removeItem(RECENT_SEARCHES_KEY);
            updateAutocomplete('');
        }

        function getShipIcon() {
            return `<svg viewBox="0 0 24 24"><path d="M20 21c-1.39 0-2.78-.47-4-1.32-2.44 1.71-5.56 1.71-8 0C6.78 20.53 5.39 21 4 21H2v2h2c1.38 0 2.74-.35 4-.99 2.52 1.29 5.48 1.29 8 0 1.26.65 2.62.99 4 .99h2v-2h-2zM3.95 19H4c1.6 0 3.02-.88 4-2 .98 1.12 2.4 2 4 2s3.02-.88 4-2c.98 1.12 2.4 2 4 2h.05l1.89-6.68c.08-.26.06-.54-.06-.78s-.34-.42-.6-.5L20 10.62V6c0-1.1-.9-2-2-2h-3V1H9v3H6c-1.1 0-2 .9-2 2v4.62l-1.29.42c-.26.08-.48.26-.6.5s-.15.52-.06.78L3.95 19zM6 6h12v3.97L12 8 6 9.97V6z"/></svg>`;
        }

        function getClockIcon() {
            return `<svg viewBox="0 0 24 24"><path d="M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm.5-13H11v6l5.2 3.2.8-1.3-4.5-2.7V7z"/></svg>`;
        }

        function highlightMatch(text, query) {
            if (!query) return escapeHtml(text);
            const escaped = escapeHtml(text);
            const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
            return escaped.replace(regex, '<mark>$1</mark>');
        }

        function levenshteinDistance(a, b) {
            const matrix = Array(b.length + 1).fill(null).map(() => Array(a.length + 1).fill(null));
            for (let i = 0; i <= a.length; i++) matrix[0][i] = i;
            for (let j = 0; j <= b.length; j++) matrix[j][0] = j;
            for (let j = 1; j <= b.length; j++) {
                for (let i = 1; i <= a.length; i++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    matrix[j][i] = Math.min(matrix[j][i - 1] + 1, matrix[j - 1][i] + 1, matrix[j - 1][i - 1] + cost);
                }
            }
            return matrix[b.length][a.length];
        }

        function findSuggestions(query) {
            if (!query || query.length < 2) return [];
            const q = query.toLowerCase();

            // Exact and prefix matches
            const matches = allShips.filter(ship =>
                ship.name.toLowerCase().includes(q) || ship.imo.includes(q)
            ).slice(0, MAX_SUGGESTIONS);

            return matches;
        }

        function findFuzzyMatch(query) {
            if (!query || query.length < 3) return null;
            const q = query.toLowerCase();

            // Find closest match using Levenshtein distance
            let bestMatch = null;
            let bestScore = Infinity;

            for (const ship of allShips.slice(0, 2000)) { // Limit for performance
                const words = ship.name.toLowerCase().split(/\s+/);
                for (const word of words) {
                    if (word.length >= 3) {
                        const dist = levenshteinDistance(q, word);
                        if (dist < bestScore && dist <= 2 && dist < word.length * 0.4) {
                            bestScore = dist;
                            bestMatch = ship;
                        }
                    }
                }
            }

            return bestMatch;
        }

        function updateAutocomplete(query) {
            const dropdown = document.getElementById('autocomplete-dropdown');
            const recent = getRecentSearches();
            const suggestions = findSuggestions(query);

            let html = '';

            // Show recent searches if no query
            if (!query && recent.length > 0) {
                html += `<div class="autocomplete-section">
                    <div class="autocomplete-section-title">Recent Searches</div>
                    ${recent.map(ship => `
                        <div class="autocomplete-item" data-imo="${ship.imo}">
                            <div class="autocomplete-item-icon recent">${getClockIcon()}</div>
                            <div class="autocomplete-item-content">
                                <div class="autocomplete-item-name">${escapeHtml(ship.name)}</div>
                                <div class="autocomplete-item-meta">${escapeHtml(ship.type)}</div>
                            </div>
                            <div class="autocomplete-item-rank">#${ship.rank}</div>
                        </div>
                    `).join('')}
                    <div class="clear-recent" onclick="clearRecentSearches()">Clear recent</div>
                </div>`;
            }

            // Show suggestions
            if (query && suggestions.length > 0) {
                html += `<div class="autocomplete-section">
                    <div class="autocomplete-section-title">Ships</div>
                    ${suggestions.map(ship => `
                        <div class="autocomplete-item" data-imo="${ship.imo}">
                            <div class="autocomplete-item-icon">${getShipIcon()}</div>
                            <div class="autocomplete-item-content">
                                <div class="autocomplete-item-name">${highlightMatch(ship.name, query)}</div>
                                <div class="autocomplete-item-meta">${escapeHtml(ship.type)} · IMO ${ship.imo}</div>
                            </div>
                            <div class="autocomplete-item-rank">#${ship.rank}</div>
                        </div>
                    `).join('')}
                </div>`;
            }

            // Show "did you mean" if no matches but fuzzy match found
            if (query && suggestions.length === 0) {
                const fuzzyMatch = findFuzzyMatch(query);
                if (fuzzyMatch) {
                    html += `<div class="autocomplete-hint">
                        Did you mean <a href="#" onclick="selectShip('${fuzzyMatch.imo}'); return false;">${escapeHtml(fuzzyMatch.name)}</a>?
                    </div>`;
                } else {
                    html += `<div class="autocomplete-hint">No ships found matching "${escapeHtml(query)}"</div>`;
                }
            }

            dropdown.innerHTML = html;
            dropdown.classList.toggle('visible', html.length > 0);
            selectedAutocompleteIndex = -1;

            // Add click handlers
            dropdown.querySelectorAll('.autocomplete-item').forEach((item, index) => {
                item.addEventListener('click', () => selectShip(item.dataset.imo));
                item.addEventListener('mouseenter', () => {
                    dropdown.querySelectorAll('.autocomplete-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    selectedAutocompleteIndex = index;
                });
            });
        }

        function selectShip(imo) {
            const ship = allShips.find(s => s.imo === imo);
            if (ship) {
                saveRecentSearch(ship);
                window.location.href = `ship.html?id=${encodeId(imo)}`;
            }
        }

        function hideAutocomplete() {
            document.getElementById('autocomplete-dropdown').classList.remove('visible');
        }

        // Event listeners
        document.getElementById('year-select').addEventListener('change', (e) => {
            loadData(e.target.value);
        });

        const searchInput = document.getElementById('search');

        searchInput.addEventListener('input', (e) => {
            applyFilters();
            updateAutocomplete(e.target.value.trim());
        });

        searchInput.addEventListener('focus', () => {
            updateAutocomplete(searchInput.value.trim());
        });

        searchInput.addEventListener('keydown', (e) => {
            const dropdown = document.getElementById('autocomplete-dropdown');
            const items = dropdown.querySelectorAll('.autocomplete-item');

            if (e.key === 'ArrowDown') {
                e.preventDefault();
                selectedAutocompleteIndex = Math.min(selectedAutocompleteIndex + 1, items.length - 1);
                items.forEach((item, i) => item.classList.toggle('selected', i === selectedAutocompleteIndex));
            } else if (e.key === 'ArrowUp') {
                e.preventDefault();
                selectedAutocompleteIndex = Math.max(selectedAutocompleteIndex - 1, 0);
                items.forEach((item, i) => item.classList.toggle('selected', i === selectedAutocompleteIndex));
            } else if (e.key === 'Enter' && selectedAutocompleteIndex >= 0) {
                e.preventDefault();
                const selectedItem = items[selectedAutocompleteIndex];
                if (selectedItem) selectShip(selectedItem.dataset.imo);
            } else if (e.key === 'Escape') {
                hideAutocomplete();
            }
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.autocomplete-container')) {
                hideAutocomplete();
            }
        });

        document.getElementById('ship-type-filter').addEventListener('change', applyFilters);

        document.getElementById('prev-btn').addEventListener('click', () => {
            if (currentPage > 1) {
                currentPage--;
                renderTable();
            }
        });

        document.getElementById('next-btn').addEventListener('click', () => {
            const totalPages = Math.ceil(filteredShips.length / perPage);
            if (currentPage < totalPages) {
                currentPage++;
                renderTable();
            }
        });

        document.querySelectorAll('th[data-sort]').forEach(th => {
            th.addEventListener('click', () => {
                const column = th.dataset.sort;

                document.querySelectorAll('th').forEach(h => {
                    h.classList.remove('sorted-asc', 'sorted-desc');
                });

                if (sortColumn === column) {
                    sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    sortColumn = column;
                    sortDirection = (column === 'co2' || column === 'co2eq') ? 'desc' : 'asc';
                }

                th.classList.add(sortDirection === 'asc' ? 'sorted-asc' : 'sorted-desc');

                sortShips();
                currentPage = 1;
                renderTable();
            });
        });

        // ============================================
        // EMISSIONS TREND POPUP
        // ============================================
        let trendChart = null;
        const yearlyTotals = {};

        // Pre-load totals from all years for the trend chart
        ['2020', '2021', '2022', '2023', '2024'].forEach(year => {
            fetch(`json/${year}_ships_data.json`)
                .then(r => r.json())
                .then(data => {
                    yearlyTotals[year] = {
                        emissions: year === '2024' ? data.total_co2eq : data.total_co2,
                        ships: data.total_ships,
                        label: year === '2024' ? 'CO2-eq' : 'CO2'
                    };
                })
                .catch(() => {});
        });

        function showTrendPopup() {
            const overlay = document.getElementById('trend-overlay');
            overlay.classList.add('visible');

            const years = ['2020', '2021', '2022', '2023', '2024'];
            const data = years.map(y => yearlyTotals[y]).filter(Boolean);
            if (data.length === 0) return;

            const emissions = years.map(y => yearlyTotals[y] ? yearlyTotals[y].emissions / 1000000 : null);
            const labels = years.map(y => yearlyTotals[y] ? `${y}${y === '2024' ? ' (CO2-eq)' : ''}` : y);

            const barColors = emissions.map((val, i) => {
                if (i === 0 || val === null) return '#4ecdc4';
                const prev = emissions[i - 1];
                if (prev === null) return '#4ecdc4';
                return val > prev ? '#ff6b6b' : '#4ecdc4';
            });

            if (trendChart) trendChart.destroy();

            const ctx = document.getElementById('trendChart').getContext('2d');
            trendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Total Emissions (million tonnes)',
                        data: emissions,
                        backgroundColor: barColors,
                        borderColor: barColors,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const y = years[context.dataIndex];
                                    const info = yearlyTotals[y];
                                    if (!info) return '';
                                    return [
                                        `${info.label}: ${(info.emissions / 1000000).toFixed(2)} million tonnes`,
                                        `Ships: ${info.ships.toLocaleString()}`
                                    ];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            beginAtZero: false,
                            ticks: {
                                color: '#888',
                                callback: function(value) { return value.toFixed(0) + ' M'; }
                            },
                            grid: { color: 'rgba(255,255,255,0.1)' },
                            title: { display: true, text: 'Million tonnes', color: '#888' }
                        }
                    }
                }
            });
        }

        document.getElementById('co2-stat-box').addEventListener('click', showTrendPopup);

        document.getElementById('trend-close').addEventListener('click', () => {
            document.getElementById('trend-overlay').classList.remove('visible');
        });

        document.getElementById('trend-overlay').addEventListener('click', (e) => {
            if (e.target === e.currentTarget) {
                e.currentTarget.classList.remove('visible');
            }
        });

        // Initial load
        loadData('2024');
    </script>
</body>
</html>
